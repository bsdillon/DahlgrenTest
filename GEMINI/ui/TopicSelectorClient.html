<!DOCTYPE html>
<html>
  <head>
    <title>Websocket Client</title>

    <style>
      .modal {
        display: none;
        position: fixed;
        z-index: 1;
        padding-top: 100px;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgb(0,0,0);
        background-color: rgba(0,0,0,0.4);
      }

      .modal-content {
        background-color: #fefefe;
        margin: auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
      }

      .close {
        color: #aaaaaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
      }

      .close:hover,
      .close:focus {
        color: #000;
        text-decoration: none;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h1>Topic Selector Panel Client</h1>
    <p>
      <button onClick="startSocket();">Connect</button>
      <button onClick="stopSocket();">Disconnect</button>
      <button onClick="checkSocket();">Check</button>
      <button onClick="testMessage();">Test</button>
      <button onClick="topicsTestMessage();">Test2</button>
    </p>

    <div id="topicSelectorModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <p>Select a file to load:</p>
        <p id="modalText"></p>
        <button onClick="loadFile();">Load</button>
      </div>
    </div>

    <script type="text/javascript">

    //Variables and functions having to do with the Websocket
      var wsUri = "ws://localhost:1337";
      var websocket = null;

      function startSocket(){
        try{
          if(websocket && websocket.readyState == 1){
            websocket.close();
          }

          websocket = new WebSocket(wsUri);

          websocket.onopen = function(evt){
            console.log("Connected");
          }

          websocket.onclose = function(evt){
            console.log("Disconnected");
          }

          websocket.onerror = function(evt){
            console.log('Error: ' + evt.data);
          }

          websocket.onmessage = function(event){
            var message = event.data;
            var fileNames;
            var displayMes;
            var i;

            console.log("Message from the server: " + message);

            if(event.data.startsWith("filenames:")){
              fileNames = message.split(":");
              displayMes = '<lable for="' + fileNames[1] + '">' + fileNames[1] + '</lable>' + "\n" + '<input type="radio" name="file" id="' + fileNames[1] + '" value="' + fileNames[1] + '"><br>' + "\n";

              if(fileNames.length > 2){
                for(i = 2; i < fileNames.length; i++){
                  if(!(fileNames[i] === "")){
                    displayMes += '<lable for="' + fileNames[i] + '">' + fileNames[i] + '</lable>' + "\n";
                    displayMes += '<input type="radio" name="file" id="' + fileNames[i] + '" value="' + fileNames[i] + '"><br>' + "\n";
                  }
                }
              }
              console.log(displayMes);
            }else if(event.data == "empty!"){
              displayMes = "Directory is empty!";
            }
            document.getElementById("modalText").innerHTML = displayMes;
          }
        } catch (exception){
            console.log('Error: ' + exception);
        }
      }

      function stopSocket(){
        if(websocket){
          websocket.close();
        }
      }

      function checkSocket(){
        if (websocket != null){
          var stateStr;
          switch (websocket.readyState) {
            case 0: {
              stateStr = "Connecting";
              break;
            }
            case 1: {
              stateStr = "Open";
              break;
            }
            case 2: {
              stateStr = "Closing";
              break;
            }
            case 3: {
              stateStr = "Closed";
              break;
            }
            case 4: {
              stateStr = "Unknown";
              break;
            }
          }

          console.log("WebSocket state = " + websocket.readyState + "("+ stateStr +")");
        } else {
            console.log("Websocket state = Null");
          }
      }

      //Variables and functions having to do with the modal popup
      var modal = document.getElementById("topicSelectorModal");
      var span = document.getElementsByClassName("close")[0];

      function openModal(){
        modal.style.display = "block";
      }

      span.onclick = function(){
        modal.style.display = "none";
      }

      window.onclick = function(event){
        if (event.target == modal){
          modal.style.display = "none";
        }
      }

      //Functions connected to the buttons
      function testMessage(){
        websocket.send("Function:loadTopicsFromFile");
      }

      function topicsTestMessage(){
        websocket.send("Function:requestSavedTopicLists");
        openModal();
      }

      function loadFile(event){
        const rbs = document.querySelectorAll('input[name="file"]');
        let selectedValue;

        for(const rb of rbs){
          if(rb.checked){
            selectedValue = rb.value;
            break;
          }
        }
        websocket.send("loadSaveFile:" + selectedValue);
        console.log(selectedValue);
      }
    </script>
  </body>
</html>
