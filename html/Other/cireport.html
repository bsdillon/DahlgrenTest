<!DOCTYPE html>
<html>
  <head>
    <title>Code-Inspector Report</title>
    <link rel="stylesheet" type="text/css" href="../common.css">
    <script src="https://cdn.anychart.com/releases/v8/js/anychart-core.min.js"></script>
    <script src="https://cdn.anychart.com/releases/v8/js/anychart-treemap.min.js"></script>
    <script src="../graphing/utils/Chart.min.js"></script>
    <script src="../graphing/utils/utils.js"></script>
    <script src="./createlinechart.js"></script>
    <script src="./../cidata/code_inspect.js"></script>
    <script>
      //https://medium.com/@AnyChart/how-to-create-treemap-chart-using-javascript-treemap-visualizes-latest-internet-users-statistics-7e600f6ae247
      var dates = [];
      var sevCounts = {};
      var sevs = ["Critical", "Important", "Consider", "Minor"];
      var catCounts = {};
      var cats = ["Unknown", "Error Prone", "Code Style", "Best Practice", "Safety", "Security", "Design", "Deployment", "Performance", "Documentation"];
      var comboCounts = {};
      var lastDate;
      var sevStacked = {};
      var catStacked = {};
      var comboStacked = {};
      var groups = {}
      var categories = {}

      function emptytt()
      {
        //tool tip does nothing
      }

      function loadData()
      {
        width = 600;
        height = 600;
        config = createConfig('Code-Inspector Violation Trends','Date','Number of Violations',emptytt, true);
        line = createChart("can",width,height,config);

        parseData();

        loadSeverity();
        CreateTree(lastDate);
      }

      function parseData()
      {
        //set up counts that will ensure solid data for all dates
        var datecount = 0;
        var s_index = {}
        var c_index = {}
        var com_index = {};
        for (i in sevs)
        {
          var k = sevs[i];
          s_index[k]=0;
          sevCounts[k]=[];
          for (j in cats)
          {
            var c = cats[j];
            com_index[k+" "+c]=0;
            comboCounts[k+" "+c]=[];
            groups[k+" "+c]=i;
            categories[k+" "+c]=j;
          }
        }

        for (i in cats)
        {
          var c = cats[i];
          c_index[c]=0;
          catCounts[c]=[];
        }

        //start parsing the data
        var format = {day: '2-digit', month: '2-digit', year: 'numeric'};
        lastDate = new Date(0);
        for (const [key, value] of Object.entries(ci_violations))
        {
          datecount++;
          //first get the date as a short string
          var d = new Date(Date.parse(key));
          if(d.getTime()>lastDate.getTime())
          {
            //update last time
            lastDate = d;
          }
          var date = d.toLocaleDateString('en-US', format);
          dates.push(date);

          //store all counts per category/severity for this date
          var tempS = {};
          var tempC = {};
          for (const [key2, value2] of Object.entries(value))
          {
            //figure out the severity and category statements
            var k = key2.replace('_',' ');
            while(k.indexOf('_')>-1)
            {
              k = k.replace('_',' ');
            }
            var index = k.indexOf(' ');
            var severity = k.substr(0,index);
            var category = k.substr(index+1, k.length);
            var count = value2.length;

            //push the combination data
            comboCounts[k].push(count);
            com_index[k]++;

            if(!(severity in tempS))
            {
              tempS[severity]=0;
            }
            tempS[severity]+= count;

            if(!(category in tempC))
            {
              tempC[category]=0;
            }
            tempC[category]+= count;
          }

          //at this point we need to copy over data
          //and otherwise put in a zero.
          for (k in s_index)
          {
            if (k in tempS)
            {
              sevCounts[k].push(tempS[k]);
            }
            else
            {
              sevCounts[k].push(0);
            }
            s_index[k]++;
          }

          for (k in c_index)
          {
            if (k in tempC)
            {
              catCounts[k].push(tempC[k]);
            }
            else
            {
              catCounts[k].push(0);
            }
            c_index[k]++;
          }

          for (k in com_index)
          {
            if (com_index[k]!=datecount)
            {
              comboCounts[k].push(0);
              com_index[k]++;
            }
          }
        }
      }

      function CreateTree(date)
      {
        //var treeData = anychart.data.tree(data, "as-tree");
        //var chart = anychart.treeMap(treeData);
        //chart.title("Severity and Category of violations");
        // set the container id
        //chart.container("tree");
        // draw the chart
        //chart.draw();
      }

      function loadSeverity()
      {
        clearData(config)
        //create a line chart with all the combo types stacked.
        setChartLabels(config, dates);
        var group = 0;
        for(k in sevCounts)
        {
          createRandomStyleArea(config, k, sevCounts[k]);
          group++;
        }
        line.update();
      }

      function loadCategory()
      {
        clearData(config)
        //create a line chart with all the combo types stacked.
        setChartLabels(config, dates);
        var cat = 0;
        for(k in catCounts)
        {
          createRandomStyleArea(config, k, catCounts[k]);
          cat++;
        }
        line.update();
      }

      function loadCombo()
      {
        clearData(config)
        //create a line chart with all the combo types stacked.
        setChartLabels(config, dates);
        for(k in comboCounts)
        {
          createGroupStyleArea(config, k, comboCounts[k], groups[k], categories[k]);
        }
        line.update();
      }
    </script>
  </head>
  <body onload="loadData()">
    <h3>Code Inspector Report</h3>
    <p>This report shows the nightly count of violations found by <a href='code-inspector.com'>Code Inspector</a></p>
    <canvas id="can"></canvas>
    <p><button onclick="loadSeverity()">Severity</button><button onclick="loadCategory()">Category</button><button onclick="loadCombo()">Severity & Category</button>
    </p>
    <div id="tree"></div>
  </body>
</html>
