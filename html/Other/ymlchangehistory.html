<!DOCTYPE html>
<html>
  <head>
    <title>Project Health</title>
    <link rel="stylesheet" type="text/css" href="../common.css">
    <style>
      table, th, td {border: 1px solid black;}
      th {background-color:#cccccc;}
      td {background-color:white;}
    </style>
    <script src="https://www.chartjs.org/dist/2.9.3/Chart.min.js"></script>
    <script src="https://www.chartjs.org/samples/latest/utils.js"></script>
    <script src="./../cidata/yml_history.js"></script>
    <script>
      var myLine;
      var ctx;
      var myCanvas;
      var marker = ['circle', 'rect', 'rectRot','triangle'];
      var style = [[1,5,0],[2,10,5],[2,5,3],[3,1,2],[3,3,5]];
      var config = {
        type: 'line',
        data: {datasets: []
        },
        options:
        {
          responsive: false,
          legend: 
          {
            labels: 
            {
              usePointStyle: true
            }
          },
          title:
          {
            display: true,
            text: 'COVID Trends'
          },
          tooltips:
          {
            mode: 'point',
            intersect: false,
          },
          hover:
          {
            mode: 'nearest',
            intersect: true
          },
          scales:
          {
            xAxes: 
            [
              {
                display: true,
                scaleLabel: 
                {
                  display: true,
                  labelString: 'Date'
                }
              }
            ],
            yAxes: 
            [
              {
                display: true,
                scaleLabel: 
                {
                  display: true,
                  labelString: 'Proportionate Graph'
                },
                ticks: 
                {
                  suggestedMin: 0,
                  suggestedMax: 1.2
                }
              }
            ]
          }
        }
      };

      function loadData()
      {
        myCanvas = document.getElementById("can");
        ctx = myCanvas.getContext("2d");
        width = myCanvas.width = 600;
        height = myCanvas.height = 600;
        myLine = new Chart(ctx, config);

        processData();
        myLine.update();
      }
      var fileData = {};

      function processData()
      {
        var colorNames = Object.keys(window.chartColors);
        var raw = {};
        var dates = [];
        var format = {day: '2-digit', month: '2-digit', year: 'numeric'};

        for (const [key, value] of Object.entries(commit))
        {
          //first get the date as a short string
          var d = new Date(Date.parse(key));
          dates.push(d.getTime());
          var date = d.toLocaleDateString('en-US', format);

          //set up the raw data for this date. SOMETHING must be there
          raw[date]={};

          for (let i=0;i<value["files"].length;i++)
          {
            if(!(value["files"][i] in raw[date]))
            {
              //the first time that a file shows up in one date, start at zero
              raw[date][value["files"][i]]=0
            }
            //increment the version number by one for that date
            raw[date][value["files"][i]]++;

            if(!(value["files"][i] in fileData))
            {
              //the first time that a file shows up in, start an empty dictionary
              fileData[value["files"][i]]={};
            }

            if(!(date in fileData[value["files"][i]]))
            {
              //the first time that a data shows up for a specific file, start an empty string
              fileData[value["files"][i]][date]="";
            }
            //add the developer name and message to the string. This may build to several versions.
            fileData[value["files"][i]][date]+=value["developer"]+": "+value["message"]+"\n";
          }
        }

        //sort all dates to get sorted dates value.
        dates.sort();

        //get all the file versions starting with zero for all files
        var fileLines = {};
        var index = 0;
        for (const [file,set] of Object.entries(fileData))
        {
          var colorName = colorNames[index % colorNames.length];
          var c = window.chartColors[colorName];
          fileLines[file] =
          {
            label: file,
            backgroundColor: Chart.helpers.color(window.chartColors[colorName]).alpha(0.5).rgbString(),
            borderColor: c,
            borderWidth: style[index % style.length][0],
            data: [0],
            fill: false,
            pointStyle: marker[index % marker.length],
            pointRadius: 5,
            pointBorderColor: 'rgb(0, 0, 0)',
            borderDash: [style[index % style.length][1],style[index % style.length][2]]
          };
          config.data.datasets.push(fileLines[file]);
          index++;
        }

        //update the versions for all dates
        for (dInt of dates)
        {
          var d = new Date(0);//start from epoch
          d.setUTCSeconds(dInt/1000);
          var date = d.toLocaleDateString('en-US', format);//get the string
          config.data.labels.push(date);//store date          

          for(var file in raw[date])
          {
            //update the version by count and save
            var nextVersion = fileLines[file].data[fileLines[file].data.length]+raw[date][file];
            fileLines[file].data.push(nextVersion);
          }
        }
      }
    </script>
  </head>
  <body onload="loadData()">
    <canvas id="can"></canvas>
  </body>
</html>
